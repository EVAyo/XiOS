# iOS接入融云

新手引导：[https://support.rongcloud.cn/ks/MTA2NA==](https://support.rongcloud.cn/ks/MTA2NA==?type=email&tp=109&mark=1&fromrcu=322387)  

IM 快速集成：https://doc.rongcloud.cn/im/Android/5.X/ui/quick_integration 

音视频 快速集成：https://doc.rongcloud.cn/call/Android/5.X/callkit/import

Demo 体验：[https://www.rongcloud.cn/downloads/demo](https://www.rongcloud.cn/downloads/demo?type=email&tp=109&mark=2&fromrcu=322387)     

SDK 下载：[https://www.rongcloud.cn/downloads](https://www.rongcloud.cn/downloads?type=email&tp=109&mark=3&fromrcu=322387)   



* [客户端 SDK 体系](https://doc.rongcloud.cn/rcloud/-/-/client-library/overview)

- **SealTalk 应用**

    Android 端和 iOS 端的 SealTalk 应用集成了 IMLib 的基础通信能力。

    [下载 SealTalk 应用](https://www.rongcloud.cn/devcenter?type=demo) · [SealTalk Android 源码](https://github.com/sealtalk/sealtalk-android) · [SealTalk iOS 源码](https://github.com/rongcloud/sealtalk-ios)

- **开发者文档**

    5.X IMLib 快速上手：[Android](https://doc.rongcloud.cn/im/Android/5.X/noui/quick_integration) · [iOS](https://doc.rongcloud.cn/im/IOS/5.X/noui/quick_integration)

    4.X IMLib 快速上手：[Android](https://doc.rongcloud.cn/im/Android/4.X/noui/guide/quick/include/android) · [iOS](https://doc.rongcloud.cn/im/IOS/4.X/noui/guide/quick/include/ios) · [Web](https://doc.rongcloud.cn/im/Web/4.X/guide/quick/include/web) · [uni-app](https://doc.rongcloud.cn/im/uni-app/4.X/guide/quick/include/web) · [Flutter](https://doc.rongcloud.cn/im/Flutter/4.X/guide/quick/include/flutter) · [小程序](https://doc.rongcloud.cn/im/mini/4.X/guide/quick/include/mini)

- **API 参考文档**

    [IMLib 5.X Javadoc](https://www.rongcloud.cn/docs/api/android/imlib_v5/) · [IMLib 5.X Appledoc](https://www.rongcloud.cn/docs/api/ios/im_v5/imlib/html/)







# 融云IM整体架构

* [即时通讯网](http://www.52im.net/forum-103-1.html)
* [bilibili - 一套典型的IM通信协议设计详解，百万并发级别的IM通信协议](https://www.bilibili.com/video/BV1vB4y187DT/?from=search&vd_source=dc55c355e9f5b6174832aacfb5d8b6aa)
* [群聊系统的架构设计](https://donggeitnote.com/2022/01/08/im-architecture/)

* [阿里钉钉技术分享：企业级IM王者——钉钉在后端架构上的过人之处](https://xie.infoq.cn/link?target=http%3A%2F%2Fwww.52im.net%2Fthread-2848-1-1.html)



* [融云技术分享：全面揭秘亿级 IM 消息的可靠投递机制](https://www.163.com/dy/article/HFHV4LLO0518Q0L3.html)

* [兼具高效与易用，融云 IM 即时通讯长连接协议设计思路](https://zhuanlan.zhihu.com/p/557314852)

* [融云官网 - 技术干货](https://www.rongcloud.cn/blog/?paged=17&cat=61)
    * [【技术实践】IM 消息数据存储结构设计](https://www.rongcloud.cn/blog/?p=5104)
    * [【融云分析】 IM 即时通讯之链路保活](https://www.rongcloud.cn/blog/?p=2420)
    * [【融云分析】当我们在谈通讯安全时，我们在谈些什么](https://www.rongcloud.cn/blog/?p=2452)
* [融云segmentfault](https://segmentfault.com/u/rongyunrongcloud/articles)



## 融云整体的消息发送以及存储的流程

![](images/消息的发送以及存储的流程.png)

​		用户发送消息到服务器端后，首先会进入到消息系统中，消息系统会对消息进行分发以及存储。对于在线的接收方，会选择直接推送消息，但是遇到接收方不在线或者是消息推送失败的情况下，也会有另外的消息获取方式，接收方会主动向服务器拉取未收到的消息，但是接收方何时来服务器拉取消息以及从哪里拉取是未知的，所以消息存入到离线库的意义也就在这里。

​		消息系统存储离线的过程中，为了不影响整个系统的更为平稳，融云使用了消息队列，消息是异步存入到离线库中的。

​		在分发完消息后，消息服务会同步一份消息数据到历史消息服务中，历史消息服务会对消息进行落地存储。对于新的同步设备，会有消息漫游的需求，这也是历史消息的主要作用。在历史消息库中，客户端可以拉取任意会话的全量历史消息。



## 离线消息以及历史消息存储区别

离线消息我们存储介质选用的是 **Redis**

历史消息我们选用的是 **HBase**



## 客户端拉取消息

​		离线消息的获取针对的是自己的整个离线消息，包括所有的会话。离线消息的获取是自上而下的方式，一次获取200条。在客户端拉取离线消息的信令中，需要带上当前客户端缓存的消息的最大时间戳，上面的图我们应该知道，离线消息我们存储的是一个线性结构，Server 会根据这个时间戳向下查找离线消息，重装或者新安装 App 时，客户端可以传0上来，Server 也会缓存客户端拉取到的最后一条消息的时间戳，然后根据业务场景，客户端类型等因素来决定从哪里开始拉取，如果没有拉取完 Server 会在拉取消息的应答中带相应的标记位，告诉客户端继续拉取，客户端循环拉取，直到所有离线消息拉完。

​		历史消息的获取针对的是单一会话，在拉取过程中需要带上来对方的 ID(如果是单聊的话就是对方的 UserID，如果是群，则是群组ID以及当前会话的最前面消息的时间戳，Server 会定位到这个人的这个会话然后一次获取20条，采用的是自下而上的方式，即从最后面往前翻。只要有消息，客户端可以一直向前翻，手动触发获取会话的历史消息。



## IM 即时通讯之链路保活

* **消息链路保活机制**
    * 复合连接机制
    * 重连机制

* **推送链路保活机制**
    * iOS 手机有 APNS 来达到以上效果
    * Android官方推送系统 FCM 在国内基本不可用
        * 安卓系统上进程管理的两大机制：
            * LMK 机制：英文是Low Memory Killer, 基于 Linux 的内存管理机制衍生而来。
            * 安卓原生的权限管理机制（AppOps）
        * 基于以上两种机制，推送链路的保活也可分为两大类：
            * 进程保活：它的思路是根据 LMK 机制提高进程优先级，降低被杀的几率。
            * 进程拉活的策略和安卓系统的 AppOps 机制有关



![](images/推送流程.png)















